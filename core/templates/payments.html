{% extends "base.html" %}
{% block content %}

{{ location_about_text|safe}}

<div>
<a href="{% url 'location_payments' location.slug previous_date.year previous_date.month %}">&larr;</a>
<a href="{% url 'location_payments_today' location.slug %}">{{ this_month|date:"M, Y"}}</a>
<a href="{% url 'location_payments' location.slug next_date.year next_date.month %}">&rarr;</a>
</div>

<ul class="nav nav-tabs page-spacer">
  <li role="presentation" class="active"><a href="#summary" aria-controls="summary" role="tab" data-toggle="tab">Summary</a></li>
  <li role="presentation"><a href="#reservations" aria-controls="reservations" role="tab" data-toggle="tab">Reservations</a></li>
  <li role="presentation"><a href="#subscriptions" aria-controls="subscriptions" role="tab" data-toggle="tab">Subscriptions</a></li>
</ul>

<div class="tab-content page-spacer">

	<div role="tabpanel" class="tab-pane active" id="summary">
		<div class="row">
			<div class="col-sm-12">
				<h3 class="page-spacer">Payments Summary</h3>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-6">
			<table class="table table-striped table-hover">
				<tbody>
				<tr><td colspan="2" class="info"><h4>Reservations</h4></td></tr>
				<tr><td>Net Income from Transient Occupants</td><td>${{ summary_totals.net_rent_transient|floatformat:2 }}</td></tr>
				<tr><td>Net Rent from Residents</td><td>  ${{ summary_totals.net_rent_resident|floatformat:2 }}</td></tr>
				<tr><td><strong>Total Net income to house (net transient + net resident)</strong></td><td><strong>${{summary_totals.gross_rent|floatformat:2 }}</strong></td></tr>
				<tr><td>Gross income from transient occupants <small>(the amount that custom location taxes are calculated on.)</small></td><td>${{ summary_totals.gross_rent_transient|floatformat:2 }}</td></tr>
				<tr><td>Location Taxes ({{ summary_totals.hotel_tax_percent }}% * Gross Transient Income)</td><td>  ${{ summary_totals.hotel_tax|floatformat:2 }}</td></tr>
				<tr><td>External Payments</td><td>  ${{ summary_totals.res_external_txs_paid|floatformat:2 }}</td></tr>
				<tr><td>Fees on External Payments</td><td>  ${{ summary_totals.res_external_txs_fees|floatformat:2 }}</td></tr>
				<tr><td><strong>Total Transfer for Reservations</strong> <small>(net res income to house + hotel tax - external res payments already received - fees on external res payments)</small></td><td><strong>${{ summary_totals.res_total_transfer|floatformat:2 }}</strong></td></tr>
				<tr><td colspan="2" class="info"><h4>Subscriptions</h4></td></tr>
				<tr><td>Untaxed Subscriptions net</td><td>${{ summary_totals.untaxed_subscription_net|floatformat:2 }}</td></tr>
				<tr><td>Taxed Subscriptions Gross</td><td>${{ summary_totals.taxed_subscription_gross|floatformat:2 }}</td></tr>
				<tr><td>Taxed Subscriptions Total User Fees</td><td>${{ summary_totals.taxed_subscription_user_fees|floatformat:2 }}</td></tr>
				<tr><td>Total House Income All Subscriptions</td><td>${{ summary_totals.all_subscriptions_net|floatformat:2 }}</td></tr>
				<tr><td>External subscription payments</td><td>${{ summary_totals.sub_external_txs_paid|floatformat:2 }}</td></tr>
				<tr><td>Fees on external subscription payments</td><td>${{ summary_totals.sub_external_txs_fees|floatformat:2 }}</td></tr>
				<tr><td><strong>Total Transfer for Subscriptions</strong> <small>(net income to house + user fees - external subscr payments already received - fees on external subscr payments)</small></td><td><strong>${{ summary_totals.sub_total_transfer|floatformat:2 }}</strong></td></tr>
				<tr><td colspan="2" class="info"><h4>Total</h4></td></tr>
				<tr><td><strong>Total Transfer</strong></td><td><strong>${{ summary_totals.total_transfer|floatformat:2 }}</strong></td></tr>
			</tbody>
			</table>
		</div>
		</div>
	</div>

	<div role="tabpanel" class="tab-pane" id="reservations">

		<h3 class="page-spacer">Reservation Payments</h3>
		<table id="payment-list" class="table table-striped table-hover">
		<thead>
			<tr>
				<th>Pay Date</th>
				<th>User</th>
				<th>Res ID</th>
				<th>Nights</th>
				<th class="money">Rate</th>
				<th class="money">Total Bill</th>
				<th >Method</th>
				<th class="money">Paid</th>
				<th class="money">To House</th>
				<th class="money">Fees on House</th>
				<th class="money">Taxes</th>
			</tr>
		</thead>
		<tbody>
		{% for p in reservation_payments %}
			{% with p.bill.reservationbill.reservation as r %}
			<tr class="{% cycle 'row-even' 'row-odd' %}">
				<td>{{ p.payment_date|date:"m/d/y" }}</td>
				<td>{% if p.user %}<a href="{% url 'user_detail' p.user.username %}">{{ p.user }}</a>{% else %} No user {% endif %}</td>
				<td><a href="{% url 'reservation_detail' r.location.slug r.id %}">{{ r.id }}</a></td>
				<td>{{ r.total_nights }}</td>
				<td class="money">${{ r.rate|floatformat:2 }}</td>
				<td class="money">${{ p.bill.amount|floatformat:2 }}</td>
				<td>{{ p.payment_method }}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ p.paid_amount|floatformat:2 }}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ p.to_house|floatformat:2 }}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">{% if p.house_fees = 0 %} -- {% else %} ${{ p.house_fees|floatformat:2 }} {% endif %}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">{% if p.non_house_fees = 0 %} -- {% else %} ${{ p.non_house_fees|floatformat:2 }} {% endif %}</td>
			</tr>
			{% endwith %}
		{% endfor %}
		<tr class="total-row">
			<td>{{ reservation_totals.count }} Payments</td>
			<td colspan="6"></td>
			<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ reservation_totals.paid_amount|floatformat:2 }}</td>
			<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ reservation_totals.to_house|floatformat:2 }}</td>
			<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ reservation_totals.house_fees|floatformat:2 }}</td>
			<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ reservation_totals.non_house_fees|floatformat:2 }}</td>
		</tr>
		</tbody>
		</table>
	</div>

	<div role="tabpanel" class="tab-pane" id="subscriptions">

		<h3 class="page-spacer">Subscription Payments</h3>
		<table id="payment-list" class="table table-striped table-hover">
			<thead>
			<tr>
				<th>Pay Date</th>
				<th>User</th>
				<th>Subsciption</th>
				<th>Bill</th>
				<th class="money">Rate</th>
				<th class="money">Total Bill</th>
				<th >Method</th>
				<th class="money">Paid</th>
				<th class="money">To House</th>
				<th class="money">Fees on House</th>
				<th class="money">Taxes</th>
			</tr>
		</thead>
		<tbody>
		{% for p in subscription_payments %}
			{% with p.bill.subscriptionbill.subscription as s %}
			<tr class="{% cycle 'row-even' 'row-odd' %}">
				<td>{{ p.payment_date|date:"m/d/y" }}</td>
				<td>{% if p.user %}<a href="{% url 'user_detail' p.user.username %}">{{ p.user }}</a>{% else %} No user {% endif %}</td>
				<td><a href="{% url 'subscription_manage_detail' s.location.slug s.id %}">{{ s.id }}</a></td>
				<td>{{p.bill.subscriptionbill.period_start|date:"M Y"}}</td>
				<td class="money">${{ s.price|floatformat:2 }}</td>
				<td class="money">${{ p.bill.amount|floatformat:2 }}</td>
				<td>{{ p.payment_method }}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ p.paid_amount|floatformat:2 }}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">${{ p.to_house|floatformat:2 }}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">{% if p.house_fees = 0 %} -- {% else %} ${{ p.house_fees|floatformat:2 }} {% endif %}</td>
				<td class="money {% if p.payment_method == "Refund" %} text-danger {% endif %} ">{% if p.non_house_fees = 0 %} -- {% else %} ${{ p.non_house_fees|floatformat:2 }} {% endif %}</td>
			</tr>
			{% endwith %}
		{% endfor %}
		<tr class="total-row">
			<td>{{ subscription_totals.count }} Payments</td>
			<td colspan="6"></td>
			<td class="money">${{ subscription_totals.total_paid|floatformat:2 }}</td>
			<td class="money">${{ subscription_totals.to_house|floatformat:2 }}</td>
			<td class="money">${{ subscription_totals.house_fees|floatformat:2 }}</td>
			<td class="money">${{ subscription_totals.user_fees|floatformat:2 }}</td>
		</tr>
		</tbody>
		</table>

	</div>

</div>


{% endblock %}
