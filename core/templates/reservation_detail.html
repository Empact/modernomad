{% extends "base.html" %}
{% load staticfiles %}
{% load core_tag_extras %}

{% block content %}

{% include "snippets/messages.html" %}


<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body center">
		<p class="para-padding">
			Share this link with a 3rd party if they are submitting payment for you. 
		</p>
		<p class="bg-warning para-padding">
			https://{{domain}}{% url 'reservation_payment' location.slug reservation.uuid %}
		</p>
      </div>
    </div>
  </div>
</div>

<div class="row">
	{% if reservation.is_pending %}
		<div class="col-md-12">
			<div class="alert alert-warning">
				<span class="fa fa-smile-o"></span> 
				This reservation is pending approval and you will receive an email when it has been approved.
			</div>
		</div>
	{% endif %}
	
	{% if not reservation.is_paid %}
		<div class="col-md-12">
			<div class="alert alert-warning">
				{% if reservation.user.profile.customer_id %}
					We have a card on file and will charge your card soon.  Thank you!
				{% else %}
					<p>
						You are almost there!  We need you to enter a credit card we can use to pay for this reservation.
					</p>
					
					<form action="{% url 'user_add_card' reservation.user.username %}" 
						method="POST" id="payment-form">{% csrf_token %}

					  <span class="payment-errors"></span>

					  <div class="form-row">
					    <label>
					      <span>Card Number</span>
					      <input type="text" size="20" data-stripe="number"/>
					    </label>
					  </div>

					  <div class="form-row">
					    <label>
					      <span>CVC</span>
					      <input type="text" size="4" data-stripe="cvc"/>
					    </label>
					  </div>

					  <div class="form-row">
					    <label>
					      <span>Expiration (MM/YYYY)</span>
					      <input type="text" size="2" data-stripe="exp-month"/>
					    </label>
					    <span> / </span>
					    <input type="text" size="4" data-stripe="exp-year"/>
					  </div>

					  <button type="submit">Add Card</button>
					</form>
					
					<p>
						Someone else paying? Send them the 
						<a href="" data-toggle="modal" data-target="#myModal">3rd party payment link</a>.
					</p>
					
					<p><em><small>We use <a href="http://stripe.com">Stripe's</a> secure credit card processing with SSL encryption. Your card card information is never stored on our servers.</small></em></p>
				{% endif %}
			</div>
		</div>
	{% endif %}

	<div class="col-md-8">
		<h3>Reservation for 
			<em><a href="{% url 'user_detail' reservation.user.username %}">{{ reservation.user.first_name|title }} {{reservation.user.last_name}}</a></em>
		</h3>
		<h4>{{reservation.arrive }} - {{reservation.depart}}.</h4>
		<div class="row">
			<div class="col-md-3"><b>Room</b></div><div class="col-md-9">{{ reservation.room.name|title}}</div>
		</div>
		<div class="row">
			<div class="col-md-3"><b>Purpose of trip</b></div><div class="col-md-9">{{ reservation.purpose}}</div>
		</div>
		<div class="row">
			<div class="col-md-3"><b>Additional Comments</b></div><div class="col-md-9">{{  reservation.comments|default:"None" }}</div>
		</div>
		<div class="row">
			<div class="col-md-3"><b>Approximate arrival Time</b></div><div class="col-md-9">{{ reservation.arrival_time|default:"Not specified" }}</div>
		</div>

	</div>

	<div class="col-md-4">

		{% if user in location.house_admins.all %}
			<div class="row">
			<div class="col-sm-12 align-right">
				<a href="{% url 'reservation_manage' location.slug reservation.id %}">Manage Reservation <span class="fa fa-mail-forward"></span></a>
			</div>
			</div>
		{% endif %}
		
		<div id="reservation-amount-summary-box">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">Reservation Summary</h3>
				</div>
				{% with reservation as r %}
					{% include 'snippets/reservation_bill_line_items_and_payments.html' %}
				{% endwith %}
				<div class="panel-footer text-muted">
					<em>Cancellation policy for the {{ reservation.room }} is {{reservation.room.cancellation_policy}}.</em>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-sm-12">
				{% if reservation.is_canceled %}
					<div class="btn btn-lg btn-danger res-status-btn" disabled="disabled" type="button">Reservation Canceled</div>
				{% elif reservation.is_paid %}
					<a class="btn btn-default res-status-btn" type="button" href="{% url 'reservation_payment' location.slug reservation.uuid %}">View Receipt</a>
				{% endif %}
			</div>
		</div>
	</div> <!-- end col-md-4 -->
</div>

<div class="row top-spacer-xl">

	<div class="col-md-12">
		<h3> Also here during your Stay</h3>
		{% for subset in users_during_stay|subsets_size:12 %}
			<div class="row row-spacer">	
				{% for user in subset %}
					<div class="col-lg-1 col-sm-3 col-xs-4">
						<img src="{{ MEDIA_URL }}{{ user.profile.image_thumb|default:'static/img/default.jpg'}}" class="small-profile-pic">
						<p> <a href="{% url 'user_detail' user.username %}">{{user.first_name}} {{user.last_name}}</a> </p>
					</div>
				{% endfor %}
			</div>
		{% endfor %}
	</div>

</div>


{% ifequal reservation.user user %}
	<div class="res-modify-btn">
	{% if past %}
		<p class="notice">This reservation is in the past and cannot be modified</p>
	{% elif paid %}
		<p class="notice">This reservation has already been paid for. Please
		contact {{ contact }} if you need to make changes. </p>
	{% else %}
		<div>
			<a class="btn-inline btn btn-info" href="{{ request.get_full_path }}edit">Modify reservation</a>
			<form id="res-delete" class="btn-inline" method="post" action="{% url 'reservation_delete' location.slug reservation.id %}">{% csrf_token %} <input type="submit" class="btn-inline btn-red btn btn-link" value="Delete?"></form>
		</div> 

		<div id="dialog-confirm" title="Delete this Reservation?">
		    <p>
		        <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
		        This reservation will be permanently deleted and cannot be recovered. Are you sure?
		    </p>
		</div>

	{% endif %}
	</div>

	<div class="row">
		<p><em>Created {{reservation.created}}. Last updated {{reservation.updated}}.</em></p>
	</div>

{% endifequal %}

</div> <!-- end col -->


{% endblock %}

{% block extrajs %}
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript">
  // This identifies your website in the createToken call below
  Stripe.setPublishableKey('{{ stripe_publishable_key }}');
  
  var stripeResponseHandler = function(status, response) {
    var $form = $('#payment-form');
    if (response.error) {
      // Show the errors on the form
      $form.find('.payment-errors').text(response.error.message);
      $form.find('button').prop('disabled', false);
    } else {
      // token contains id, last4, and card type
      var token = response.id;
      // Insert the token into the form so it gets submitted to the server
      $form.append($('<input type="hidden" name="stripeToken" />').val(token));
      // and re-submit
      $form.get(0).submit();
    }
  };
  jQuery(function($) {
    $('#payment-form').submit(function(e) {
      var $form = $(this);
      // Disable the submit button to prevent repeated clicks
      $form.find('button').prop('disabled', true);
      Stripe.card.createToken($form, stripeResponseHandler);
      // Prevent the form from submitting with the default action
      return false;
    });
  });
</script>

<script>
$("#dialog-confirm").dialog({
    autoOpen: false,
    modal: true,
    buttons: {
        "Yes, Delete": function () {
            $("#res-delete").submit();
         },
        "Cancel": function () {
            $(this).dialog("close");
        }
    }
});

$("#res-delete").click(function (e) {
    $("#dialog-confirm").dialog("open");
    e.preventDefault();
});
</script>


{% endblock %}
