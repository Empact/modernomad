# Ubuntu 14.04 LTS

# Add users
adduser jacob
adduser jacob sudo
adduser jessykate
adduser jessykate sudo
adduser embassynetwork

# SSH
curl -i https://api.github.com/users/jessykate/keys
"PasswordAuthentication no" > /etc/ssh/ssh_conf

# Install apps
apt-get update
apt-get dist-upgrade
apt-get install nginx gunicorn supervisor
apt-get install git python-dev python-virtualenv python-pip
apt-get install zlib1g-dev libxml2-dev libxslt1-dev python-lxml

# PILLOW needs some libs to help with the images
sudo apt-get install libjpeg8 libjpeg62-dev libfreetype6 libfreetype6-dev
sudo ln -s /usr/lib/x86_64-linux-gnu/libjpeg.so /usr/lib
sudo ln -s /usr/lib/x86_64-linux-gnu/libfreetype.so /usr/lib
sudo ln -s /usr/lib/x86_64-linux-gnu/libz.so /usr/lib

# Setup Modernomad
sudo su - embassynetwork
mkdir logs
virtualenv webapp
cd webapp
mkdir media
mkdir static
source bin/activate
git clone https://github.com/jessykate/modernomad.git
cd modernomad
pip install -r requirements.txt
pip install --index-url https://code.stripe.com --upgrade stripe
pip install gunicorn
pip install psycopg2

# Edit local_settings.py
MEDIA_ROOT = "/home/embassynetwork/webapp/media"
STATIC_ROOT = "/home/embassynetwork/webapp/static"

# Config Nginx and Gunicorn
cp gunicorn.conf /etc/supervisor/conf.d/gunicorn.conf
cp gunicorn_start /home/embassynetwork/bin/gunicorn_start
cp embassynetwork /etc/nginx/sites-available/embassynetwork
ln -s /etc/nginx/sites-available/embassynetwork /etc/nginx/sites-enabled/

# Restart everything
supervisorctl reload 
service nginx restart
supervisorctl restart gunicorn

#######################################
# Extra Credit
#######################################

# Install Postgres
sudo apt-get install postgresql postgresql-client-common 
sudo apt-get install python-psycopg2 libpq-dev
sudo -u postgres psql
  -> ALTER USER postgres PASSWORD 'newpassword';
sudo vi /etc/postgresql/9.3/main/pg_hba.conf
  -> local	all	postgres	md5
sudo service postgresql restart

# Porting SQLite3 to Postgres
./manage.py dumpdata > alldata.json
./manage.py syncdb
./manage.py migrate
./manage.py dbshell
  -> TRUNCATE django_content_type CASCADE;
./manage.py loaddata alldata.json 

./manage.py dumpdata --exclude=contenttypes --exclude=auth.Permission  > data.json
vi modernomad.local_settins.py
DATABASES = {
    'default': {
                'ENGINE':'django.db.backends.postgresql_psycopg2',
                'USER':'postgres',
                'NAME':'modernomadb',
                'PASSWORD':'PASSWORD',
                'HOST': 'localhost',
                'PORT':'5432'
    }
}

# Data Cleanup
cp media/data/avatars/default.jpg media/data/avatars/Jessicat/Thompson\ small.jpg

./manage.py migrate gather --fake 0009
./manage.py migrate gather

cd media/data/events
mv Sexual-Energetics-Workshop-Coed\:\ sex\ energy\,\ chakras\,\ and\ creating\ safe\ space./ Sexual-Energetics-Workshop-Coed
mv private-event-session-one-a-brainstorm-group-for-b/ private-event-session-one-a-brainstorm-group
mv institute-for-the-future-and-organized-crime-and-c/ institute-for-the-future-and-organized-crime
mv welcome-gathering-for-indong-cho-head-of-seouls-in/ welcome-gathering-for-indong-cho
mv daughters-of-the-internet-revolution-welcomes-stac/ daughters-of-the-internet-revolution-welcomes
mv aia-architecture-in-the-city-exhibition-photo-shoo/ aia-architecture-in-the-city-exhibition-photo
mv evening-of-live-music-eastern-european-french-mini/ evening-of-live-music-eastern-european-french
cat data.json | python -m json.tool > expanded.json
vi expanded.json
 -> Edit paths from above
./manage.py loaddata expanded.json

cd media
mkdir avatars
(modernomad)Marta-3:media jacob$ mkdir locations
(modernomad)Marta-3:media jacob$ mkdir rooms
(modernomad)Marta-3:media jacob$ mkdir events
(modernomad)Marta-3:media jacob$ cp avatars/d
(modernomad)Marta-3:media jacob$ cp data/avatars/default.jpg avatars/
(modernomad)Marta-3:media jacob$ cp data/avatars/default.jpg locations/
(modernomad)Marta-3:media jacob$ cp data/avatars/default.jpg rooms/


./manage.py loaddata eventadmingroup.json 
[
    {
        "fields": {
            "location": 1,
            "users": [
                1
            ]
        },
        "model": "gather.eventadmingroup",
        "pk": 1
    }
]
