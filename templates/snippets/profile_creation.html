{% load staticfiles %}

<p class="">Introduce yourself! This information will shared with other members of the community (and theirs with you).</p>
{% if not user.is_authenticated %}
	<p>If you already have an account, you can <a href="/people/login/">log in</a> instead. </p>
{% endif %}

<hr>

<div class="row">
	<div class="col-md-8">
		<form class="registration-form form-horizontal" id="newprofileform" enctype="multipart/form-data" method="post">
			{% csrf_token %}
			<div class="form-group">
				<!-- image cropping -->
					<p id="img-upload-error"></p>
					<label class="light col-sm-2 control-label">
						{% if has_image %}
							Update image (optional)
						{% else %}
							<sup><small><span class="text-danger"><i class="fa fa-asterisk"></i></span></small></sup> Image 
						{% endif %}
					</label>
					<div class="form-field-body col-sm-10">
						<input type="file" id="image_file"/>
					</div>
					<div class="form-field-body col-sm-12">
						<div class="form-group" id="cropping-area">
							<div class="col-md-7 pull-left">
								<h3>Source</h3>
								<div id="image_input"></div>
							</div>
							<div class="col-md-5 pull-left">
								<h3>Your Avatar</h3>
								<img id="image_output" style="border:1px solid #000"/>
								<!-- <textarea id="image_source" style="height:100px;width:100px"> -->
								<input type="hidden" name="image" id="id_image">
							</div>
						</div>
					</div>
			</div>
			<div class="clear"></div>

			<div class="form-group">
				{{ form.bio.errors|safe }}
				<label class="light col-sm-2 control-label" for="{{form.bio.label.id_for_label}}">{{ form.bio.label }}</label>
				<div class="form-field-body col-sm-10">
					{{ form.bio }}
				</div>
			</div>

			<div class="form-group">
				{{ form.projects.errors|safe }}
				<label class="light col-sm-2 control-label" for="{{form.projects.label.id_for_label}}">{{ form.projects.label }}</label>
				<div class="form-field-body col-sm-10">
					{{ form.projects }}
					<span class="form-help-text">{{ form.projects.help_text }}</span>
				</div>
			</div>

			<div class="form-group">
				{{ form.sharing.errors|safe }}
				<label class="light col-sm-2 control-label" for="{{form.sharing.label.id_for_label}}">{{ form.sharing.label }}</label>
				<div class="form-field-body col-sm-10">
					{{ form.sharing }}
					<span class="form-help-text">{{ form.sharing.help_text }}</span>
				</div>
			</div>

			<div class="form-group">
				{{ form.discussion.errors|safe }}
				<label class="light col-sm-2 control-label" for="{{form.discussion.label.id_for_label}}">{{ form.discussion.label }}</label>
				<div class="form-field-body col-sm-10">
					{{ form.discussion }}
					<span class="form-help-text">{{ form.discussion.help_text }}</span>
				</div>
			</div>

			<div class="form-group">
				{{ form.links.errors|safe }}
				<label class="light col-sm-2 control-label" for="{{form.links.label.id_for_label}}">{{ form.links.label }}</label>
				<div class="form-field-body col-sm-10">
					{{ form.links }}
					<span class="form-help-text">{{ form.links.help_text }}</span>
				</div>
			</div>

			<h3>Account Information</h3>
	
			<hr>

			<div class="form-group">
				{{ form.first_name.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.first_name }}
					<span class="form-help-text">{{ form.first_name.help_text }}</span>
				</div>
				{{ form.last_name.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.last_name }}
					<span class="form-help-text">{{ form.last_name.help_text }}</span>
				</div>
				{{ form.email.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.email }}
					<span class="form-help-text">{{ form.email.help_text }}</span>
				</div>
			</div>

			<div class="form-group">
				{{ form.referral.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.referral }}
					<span class="form-help-text">{{ form.referral.help_text }}</span>
				</div>
				{{ form.city.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.city }}
					<span class="form-help-text">{{ form.city.help_text }}</span>
				</div>
			</div>

			<hr>

			<div class="form-group">
				{{ form.username.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.username }}
					<span class="form-help-text">{{ form.username.help_text }}</span>
				</div>
				{{ form.password1.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.password1 }}
					<span class="form-help-text">{{ form.password1.help_text }}</span>
				</div>
				{{ form.password2.errors|safe }}
				<div class="form-field-body col-sm-4">
					{{ form.password2 }}
					<span class="form-help-text">{{ form.password2.help_text }}</span>
				</div>

			</div>

		  <input id="profilesubmit" class="btn btn-primary" type="submit" value="Submit" />

		</form>
	</div>
	<div class="col-md-4" id="res-detail">
		{% if reservation %}
			<div id="reservation-amount-summary-box">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">Reservation Summary</h3>
					</div>
					{% with reservation as r %}
						{% include 'snippets/reservation_bill_line_items_and_payments.html' %}
					{% endwith %}
					<div class="panel-footer text-muted">
						<em>Cancellation policy for the {{ reservation.room }} is {{reservation.room.cancellation_policy}}.</em>
					</div>
				</div>
			</div>
		{% endif %}
	</div>
</div>

<!-- client side form validation -->
<script src="{% static 'js/jquery.validate.min.js' %}"></script>
<script>
		$.validator.addMethod("uniqueUsername", function(value, element) {
			var existingUsers = [
				{% for user in all_users %}
				"{{user.username}}",
				{% endfor %}
			];
			if (existingUsers.indexOf(value) < 0) {
				return true;
			} else { 
				return false;
			}
		}, "That username is taken");

		$.validator.addMethod("uniqueEmail", function(value, element) {
			var existingEmails = [
				{% for user in all_users %}
				"{{user.email}}",
				{% endfor %}
			];
			if (existingEmails.indexOf(value) < 0) {
				return true;
			} else { 
				return false;
			}
		}, "That email address is already associated with an account");

		$.validator.addMethod("strictEmail", function(value, element) {
			console.log('validating email field');
			return /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(value);
			}, "Please provide a valid email address."
		);

		$.validator.addMethod("listOfUrls", function(value, element) {
			console.log('validating urls field');
			items = value.split(",");
			for (var i=0; i< items.length; i++) {
				var val_to_test = $.trim(items[i]);
				// new gTLDs can be up to 65 characters long :-O
				var valid = /(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,64}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g.test(val_to_test);
				if (val_to_test.length > 0 && !valid) {
					console.log(valid)
					return false;
				}
				// JKS second check to see if there's a space. not sure where
				// the above regex IS allowing a space, but it is.  
				if (/ +/.test(val_to_test)) {
					return false;
				}
			}
			return true;
			}, "One of the entered URLs is incorrectly formatted."
		);

		$("#newprofileform").validate({
			ignore: [],
			rules: {
				bio: {
					required: true
				},
				projects: {
					required: true
				},
				sharing: {
					required: true
				},
				discussion: {
					required: true
				},
				links: {
					listOfUrls: true
				},
				first_name: {
					required: true
				},
				last_name: {
					required: true
				},
				email: {
					required: true,
					strictEmail: true,
					uniqueEmail: true
				}, 
				referral: {
					required: true
				},
				city: {
					required: true
				},
				username: {
					required: true,
					uniqueUsername: true
				}
			}	
		});
</script>

<!-- image cropping -->
<script src="{% static 'js/jquery.Jcrop.min.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/jquery.Jcrop.min.css' %}" />

<script>
	var inputFile = document.getElementById('image_file');
	inputFile.addEventListener('click', function() {this.value = null;}, false);
	inputFile.addEventListener('change', readData, false);

	function readData(evt) {
		$("#cropping-area").show();
		evt.stopPropagation();
		evt.preventDefault();
		var file = evt.dataTransfer !== undefined ? evt.dataTransfer.files[0] : evt.target.files[0];
		var reader = new FileReader();
		reader.onload = (function(theFile) {
		return function(e) {
			var image = new Image();
			image.src = e.target.result;
			image.onload = function() {
			var canvas = document.createElement('canvas');
			canvas.width = 400;
			canvas.height = image.height * (400 / image.width);
			var ctx = canvas.getContext('2d');
			ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

			$('#image_input').html(['<img src="', canvas.toDataURL(), '"/>'].join(''));

			var img = $('#image_input img')[0];
			var canvas = document.createElement('canvas');

			$('#image_input img').Jcrop({
				bgColor: 'black',
				bgOpacity: .6,
				setSelect: [0, 0, 200, 200],
				aspectRatio: 1,
				onSelect: imgSelect,
				onChange: imgSelect
			});

			function imgSelect(selection) {
				canvas.width = canvas.height = 200;

				var ctx = canvas.getContext('2d');
				ctx.drawImage(img, selection.x, selection.y, selection.w, selection.h, 0, 0, canvas.width, canvas.height);
			
				$('#image_output').attr('src', canvas.toDataURL());

				// JKS i don't understand the encoding scheme well enough
				// to know why we need to strip out the beginning data
				// prefix but it is necessary. 
				var img_data = canvas.toDataURL().match(/data:image\/(png|jpeg);base64,(.*)$/)[2];

				$('#id_image').val(img_data);
			}
			}
		}
		})(file);
		reader.readAsDataURL(file);
	}

</script>


	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
	<script>
		$("#id_city").keyup(function() {
			autocomplete = new google.maps.places.Autocomplete(this);
			google.maps.event.addListener(autocomplete, 'place_changed', function() {
				var place = autocomplete.getPlace();
				console.log(place);
				console.log(place.address_components);

			});
		});
	</script>
</div>


